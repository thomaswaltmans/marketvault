{% extends "portfolio/layout.html" %}
{% load static %}

{% block body %}
  <div id="view-profile" class="view">
    <h2>Account</h2>
    <div class="grid">
      <div class="card card-overview span-6">
        <h3>Profile</h3>
        <div style="margin-bottom: 0.75rem;">
          <label>Username</label><br>
          <input id="profile-username" disabled>
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label>Email</label><br>
          <input id="profile-email">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label>First name</label><br>
          <input id="profile-first-name">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label>Last name</label><br>
          <input id="profile-last-name">
        </div>
        <button id="btn-save-profile">Save profile</button>
        <div id="profile-status" style="margin-top:0.5rem;"></div>
      </div>

      <div class="card span-6">
        <h3>Security</h3>
        <div style="margin-bottom: 0.75rem;">
          <label>Current password</label><br>
          <input id="password-current" type="password">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label>New password</label><br>
          <input id="password-new" type="password">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label>Confirm new password</label><br>
          <input id="password-confirm" type="password">
        </div>
        <button id="btn-change-password">Change password</button>
        <div id="password-status" style="margin-top:0.5rem;"></div>
        <hr>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'logout' %}">Log Out</a>
      </div>
    </div>
  </div>

  <div id="view-dashboard" class="dashboard">
    <div class="dashboard-header">
      <h2>Dashboard</h2>
      <button id="btn-sensitive-toggle" class="sensitive-toggle" type="button" aria-pressed="false" aria-label="Hide sensitive values">
        <svg class="icon-eye" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 5C6.5 5 2.1 8.2 1 12c1.1 3.8 5.5 7 11 7s9.9-3.2 11-7c-1.1-3.8-5.5-7-11-7Zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8Z"></path>
        </svg>
        <svg class="icon-eye-off" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3.3 2.3 2 3.6l3 3C3.2 7.9 1.8 9.8 1 12c1.1 3.8 5.5 7 11 7 2.2 0 4.2-.5 5.9-1.4l2.5 2.5 1.3-1.3L3.3 2.3Zm8.7 14.7c-2.8 0-5-2.2-5-5 0-.9.2-1.7.6-2.4l6.8 6.8c-.7.4-1.5.6-2.4.6Zm0-12c5.5 0 9.9 3.2 11 7-.5 1.8-1.8 3.5-3.6 4.7l-1.5-1.5A6.9 6.9 0 0 0 19 12a7 7 0 0 0-7-7c-1.2 0-2.3.3-3.3.8L7.2 4.3C8.7 3.5 10.3 3 12 3Z"></path>
        </svg>
        <span id="sensitive-toggle-label">Hide values</span>
      </button>
    </div>
    <div class="grid">
      <div class="card card-overview span-6">
        <h3>Overview</h3>
        <div class="stats-grid-wrap">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Portfolio Value</div>
            <div id="metric-portfolio-value" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Total Invested</div>
            <div id="metric-total-invested" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Unrealized P/L</div>
            <div id="metric-unrealized-pl" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Total ROI</div>
            <div id="metric-total-roi" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">YTD ROI</div>
            <div id="metric-ytd-roi" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Dividend Yield (TTM)</div>
            <div id="metric-dividend-yield" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Best Performer</div>
            <div id="metric-best-performer" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Worst Performer</div>
            <div id="metric-worst-performer" class="stat-value">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Top Dividend Asset</div>
            <div id="metric-top-dividend-asset" class="stat-value">-</div>
          </div>
        </div>
        </div>
      </div>

      <div class="card card-allocation span-6">
        <div class="allocation-header">
          <h3>Allocation</h3>
          <div class="allocation-toggle">
            <button id="btn-allocation-assets" class="is-active" type="button">Assets</button>
            <button id="btn-allocation-types" type="button">Type</button>
          </div>
        </div>
        <div class="allocation-layout">
          <div id="chart-allocation" class="chart chart-small"></div>
          <div id="allocation-legend" class="allocation-legend"></div>
        </div>
      </div>

      <div class="card span-12">
        <h3>Portfolio Value</h3>
        <div id="chart-growth" class="chart"></div>
      </div>

      <div class="card span-12">
        <div class="card-head-row">
          <h3>Asset Growth</h3>
          <select id="asset-growth-select"></select>
        </div>
        <div id="chart-asset-growth" class="chart"></div>
      </div>
  </div>
  </div>

  <div id="view-assets" class="view">
    <h2>Assets</h2>

    <div style="margin-bottom: 1rem;">
      <input id="asset-search" placeholder="Search by ticker, name, or data symbol">
      <button id="btn-asset-search">Search</button>
      <button id="btn-toggle-asset-create">Create asset</button>
    </div>
  
    <div id="asset-create-panel" style="margin-bottom: 1rem; display:none;">
      <input id="asset-ticker" placeholder="Ticker (e.g. ASML)" />
      <input id="asset-name" placeholder="Name (optional)" />
      <select id="asset-type">
        <option value="ETF">ETF</option>
        <option value="STOCK" selected>Stock</option>
        <option value="ETC">ETC</option>
        <option value="CRYPTO">Crypto</option>
      </select>
      <input id="asset-exchange" placeholder="Exchange (optional, e.g. Euronext)" />
      <input id="asset-currency" placeholder="Currency (default EUR)" />
      <input id="asset-data-symbol" placeholder="Data symbol (e.g. ASML.AS)" />
      <button id="btn-asset-create">Create</button>
      <div id="asset-create-status"></div>
    </div>
  
    <div id="assets-list"></div>
  </div>

  <div id="view-transactions" class="view">
    <h2>Transactions</h2>
    <div style="margin-bottom: 1rem;">
      <button id="btn-new-transaction">New transaction</button>
      <button id="btn-go-import">Import file</button>
    </div>
  
    <div id="transactions-status"></div>
    <div id="transactions-list"></div>
  </div>

  <div id="view-transaction-form" class="view">
    <h2 id="transaction-form-title">New transaction</h2>

    <div style="margin-bottom: 0.75rem;">
      <label>Type</label><br>
      <select id="txn-type">
        <option value="BUY">BUY</option>
        <option value="SELL">SELL</option>
        <option value="DIV">DIV</option>
      </select>
    </div>
  
    <div style="margin-bottom: 0.75rem;">
      <label>Asset</label><br>
      <select id="txn-asset"></select>
      <div style="font-size: 0.9rem; opacity: 0.8;" id="txn-asset-hint"></div>
    </div>
  
    <div id="trade-fields">
      <div style="margin-bottom: 0.75rem;">
        <label>Quantity</label><br>
        <input id="txn-quantity" placeholder="e.g. 2 or 0.5">
      </div>
  
      <div style="margin-bottom: 0.75rem;">
        <label>Unit price</label><br>
        <input id="txn-unit-price" placeholder="e.g. 88.49">
      </div>
    </div>
  
    <div id="div-fields" style="display:none;">
      <div style="margin-bottom: 0.75rem;">
        <label>Dividend amount</label><br>
        <input id="txn-div-amount" placeholder="e.g. 12.34">
      </div>
    </div>
  
    <div style="margin-bottom: 0.75rem;">
      <label>Timestamp (optional ISO)</label><br>
      <input id="txn-timestamp" type="datetime-local" placeholder="today">
    </div>
  
    <div style="margin-top: 1rem;">
      <button id="btn-save-transaction">Save</button>
      <button id="btn-cancel-transaction">Cancel</button>
      <div id="transaction-form-status" style="margin-top:0.5rem;"></div>
    </div>
  </div>

  <div id="view-import" class="view">
    <h2>Load Transactions from Excel File</h2>
    <div class="import-help">
      <p>Upload an <code>.xlsx</code> file with one row per transaction.</p>
      <p>Required columns: <span class="import-columns"><code>data_symbol</code>, <code>txn_type</code>, <code>timestamp</code></span></p>
      <p><code>txn_type</code> must be one of: <code>BUY</code>, <code>SELL</code>, <code>DIV</code></p>
      <p>Optional columns: <span class="import-columns"><code>quantity</code>, <code>unit_price</code>, <code>div_amount</code></span></p>
      <p>Example:</p>
      <div class="import-example-table">
        <div class="import-cell import-head">data_symbol</div>
        <div class="import-cell import-head">txn_type</div>
        <div class="import-cell import-head">quantity</div>
        <div class="import-cell import-head">unit_price</div>
        <div class="import-cell import-head">div_amount</div>
        <div class="import-cell import-head">timestamp</div>

        <div class="import-cell">IWDA.AS</div>
        <div class="import-cell">BUY</div>
        <div class="import-cell">2</div>
        <div class="import-cell">88.49</div>
        <div class="import-cell"></div>
        <div class="import-cell">1704067200</div>

        <div class="import-cell">VWCE.DE</div>
        <div class="import-cell">BUY</div>
        <div class="import-cell">1.5</div>
        <div class="import-cell">103.10</div>
        <div class="import-cell"></div>
        <div class="import-cell">1706745600</div>

        <div class="import-cell">VWRL.AS</div>
        <div class="import-cell">DIV</div>
        <div class="import-cell"></div>
        <div class="import-cell"></div>
        <div class="import-cell">12.34</div>
        <div class="import-cell">1709251200</div>
      </div>
    </div>
    <input type="file" id="xlsx" accept=".xlsx" hidden>
    <label for="xlsx" class="btn-file">Choose file</label>
    <span id="file-name" style="margin-left:8px; opacity:0.8;"></span>
    <button id="btn-import">Import</button>
    <div id="import-status"></div>
  </div>
{% endblock %}

{% block script %}
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="{% static 'portfolio/js/common.js' %}"></script>
  <script src="{% static 'portfolio/js/profile.js' %}"></script>
  <script src="{% static 'portfolio/js/dashboard.js' %}"></script>
  <script src="{% static 'portfolio/js/assets.js' %}"></script>
  <script src="{% static 'portfolio/js/transactions.js' %}"></script>
  <script src="{% static 'portfolio/js/imports.js' %}"></script>
  <script src="{% static 'portfolio/js/app.js' %}"></script>
{% endblock %}
